{%- assign color_label_list = 'general.label.color' | t | replace: ', ', ',' | downcase | split: ',' -%}
{%- assign color_white_label = 'general.label.white' | t | downcase -%}
{%- assign quick_buy_icon_name = 'quick-buy-' | append: settings.cart_icon | replace: '_', '-' -%}
{% assign grouped_products = product.metafields.products.grouped_products.value %}

{%- if product.url contains '?' -%}
  {%- assign product_url_contains_query = true -%}
{%- else -%}
  {%- assign product_url_contains_query = false -%}
{%- endif -%}

<product-item class="product-item {% unless product.available %}product-item--sold-out{% endunless %}" {% if reveal %}reveal{% endif %}>
  {%- capture product_labels -%}
    {%- for label in product.metafields.custom.labels.value -%}
      <span class="label label--custom{% if label contains 'label2' %}2{% endif %}">{{ label | split: ':' | last }}</span>
    {%- endfor -%}

    {%- unless product.available -%}
      <span class="label label--subdued">{{ 'collection.product.sold_out' | t }}</span>
    {%- elsif product.selected_or_first_available_variant.inventory_quantity > 0 and product.selected_or_first_available_variant.inventory_quantity < 5 -%}
      <span class="label label--subdued">{{ 'collection.product.almost_sold_out' | t }}</span>
    {%- endunless -%}

    {%- if settings.show_discount and product.available %}
      {%- if customer and product.compare_at_price and product.price > product.compare_at_price and product.price != blank -%}
        {%- if settings.discount_mode == 'percentage' -%}
          {%- assign savings = product.price | minus: product.compare_at_price | times: 100.0 | divided_by: product.price | round | append: '%' -%}
        {%- else -%}
          {%- capture savings -%}{{ product.price | minus: product.compare_at_price | money }}{%- endcapture -%}
        {%- endif -%}
        <span class="label label--highlight">{{ 'collection.product.discount_html' | t: savings: savings }}</span>
      {%- elsif product.price < product.compare_at_price and product.compare_at_price != blank -%}
        {%- if settings.discount_mode == 'percentage' -%}
          {%- assign savings = product.compare_at_price | minus: product.price | times: 100.0 | divided_by: product.compare_at_price | round | append: '%' -%}
        {%- else -%}
          {%- capture savings -%}{{ product.compare_at_price | minus: product.price | money }}{%- endcapture -%}
        {%- endif -%}
        <span class="label label--highlight">{{ 'collection.product.discount_html' | t: savings: savings }}</span>
      {%- endif -%}
    {%- endif -%}
  {%- endcapture -%}

  <div class="product-item__image-wrapper {% if image_ratio == "square" %}image-square-ratio{% endif %} {% if image_ratio == "default" %}image-default-ratio{% endif %} {% if settings.show_secondary_image and product.media.size > 1 and hide_secondary_image != true %}product-item__image-wrapper--multiple{% endif %}">
    {%- if reduced_content != true -%}
      <div class="product-item__label-list label-list">
        {{- product_labels -}}
      </div>
    {%- endif -%}

    {%- if request.page_type == "product" and show_wishlist -%}
      <div class="product-item__wishlist">
        {%- render 'wishlist_button', product: product -%}
      </div>
    {%- endif -%}

    <a href="{{ product.url | within: collection }}" class="product-item__aspect-ratio aspect-ratio {% if settings.product_image_size != 'natural' %}aspect-ratio--{{ settings.product_image_size }}{% endif %}" style="padding-bottom: {{ 100.0 | divided_by: product.featured_media.preview_image.aspect_ratio }}%; --aspect-ratio: {{ product.featured_media.preview_image.aspect_ratio }}">
      <img class="product-item__primary-image" loading="lazy" data-media-id="{{ product.featured_media.id | escape }}" sizes="{{ sizes_attribute }}" {% render 'image-attributes', image: product.featured_media, sizes: '200,300,400,500,600,700,800,900,1000,1100,1200' %}> 
      
      <!--
      {%- if settings.product_color_display == 'swatch' -%}
        {%- assign featured_media = product.variants | map: 'featured_media' -%}

        {%- for media in featured_media -%}
          {%- unless media == product.featured_media -%}
            <img class="product-item__primary-image" hidden data-media-id="{{ media.id | escape }}" loading="lazy" sizes="{{ sizes_attribute }}" {% render 'image-attributes', image: media, sizes: '200,300,400,500,600,700,800,900,1000,1100,1200' %}>
          {%- endunless -%}
        {%- endfor -%}
      {%- endif -%}
      -->
      
      {%- if settings.show_secondary_image and product.media.size > 1 and hide_secondary_image != true -%}
        {%- assign next_media = product.media[product.featured_media.position] | default: product.media[1] -%}
        <img class="product-item__secondary-image" loading="lazy" sizes="{{ sizes_attribute }}" {% render 'image-attributes', image: next_media, sizes: '200,300,400,500,600,700,800,900,1000,1100,1200' %}>
      {%- endif -%}
    </a>

    <div class="slider-steps">
      <div class="slider-steps__item active"></div>
      <div class="slider-steps__item"></div>
    </div>

    {%- if request.page_type != 'password' and settings.product_add_to_cart and product.available and reduced_content != true and show_cta -%}
      {%- if product.variants.size == 1 -%}
        {%- capture form_id -%}product_form_{{ section.id }}_{{ block.id }}_{{ product.id }}_{% increment product_form_index %}{%- endcapture -%}
        {%- form 'product', product, is: 'product-form', id: form_id, class: 'product-item__quick-form' -%}
          <input type="hidden" name="quantity" value="1">
          <input type="hidden" name="id" value="{{ product.first_available_variant.id }}">
          <button is="loader-button" type="submit" class="button button--outline button--text button--full {% if section.settings.desktop_products_per_row >= 5 %}button--small{% endif %} hidden-touch">{{ 'collection.product.add_to_cart_short' | t }}</button>
          <button type="submit" class="product-item__quick-buy-button hidden-no-touch">
            <span class="visually-hidden">{{ 'collection.product.add_to_cart_short' | t }}</span>
            {%- render 'icon' with quick_buy_icon_name -%}
          </button>
        {%- endform -%}
      {%- else -%}
        {%- comment -%}
        IMPLEMENTATION NOTE: Depending on the device we show a different icon or open a different mode (either popover or drawer)
        {%- endcomment -%}

        <div class="product-item__quick-form">
          <button is="toggle-button" loader aria-controls="product-{{ section.id }}-{{ block.id }}-{{ product.id }}-drawer" aria-expanded="false" class="button button--outline button--text button--full {% if section.settings.desktop_products_per_row >= 5 %}button--small{% endif %} hidden-touch hidden-phone">{{ 'collection.product.quick_view' | t }}</button>
          <button is="toggle-button" aria-controls="product-{{ section.id }}-{{ block.id }}-{{ product.id }}-drawer" aria-expanded="false" class="product-item__quick-buy-button hidden-no-touch hidden-phone">
            <span class="visually-hidden">{{ 'collection.product.quick_view' | t }}</span>
            {%- render 'icon' with quick_buy_icon_name -%}
          </button>

          <button is="toggle-button" aria-controls="product-{{ section.id }}-{{ block.id }}-{{ product.id }}-popover" aria-expanded="false" class="product-item__quick-buy-button hidden-tablet-and-up">
            <span class="visually-hidden">{{ 'collection.product.quick_view' | t }}</span>
            {%- render 'icon' with quick_buy_icon_name -%}
          </button>
        </div>

        <quick-buy-popover id="product-{{ section.id }}-{{ block.id }}-{{ product.id }}-popover" href="{{ product.url }}{% if product_url_contains_query %}&{% else %}?{% endif %}view=quick-buy-popover" class="popover popover--quick-buy hidden-tablet-and-up"></quick-buy-popover>
        <quick-buy-drawer id="product-{{ section.id }}-{{ block.id }}-{{ product.id }}-drawer" href="{{ product.url }}{% if product_url_contains_query %}&{% else %}?{% endif %}view=quick-buy-drawer" class="drawer drawer--large drawer--quick-buy hidden-phone"></quick-buy-drawer>
      {%- endif -%}
    {%- endif -%}
  </div>

  <div class="product-item__info {% if show_cta %}product-item__info--with-button{% endif %} {% if reduced_font_size %}text--small{% endif %}">
    <div class="product-item-meta">
      {%- if settings.show_vendor -%}
        {%- assign vendor_handle = product.vendor | handle -%}
        {%- assign collection_for_vendor = collections[vendor_handle] -%}

        {%- unless collection_for_vendor.empty? -%}
          <a class="product-item-meta__vendor heading heading--xsmall" href="{{ collection_for_vendor.url }}">{{ product.vendor }}</a>
        {%- else -%}
          <a class="product-item-meta__vendor heading heading--xsmall" href="{{ product.vendor | url_for_vendor }}">{{ product.vendor }}</a>
        {%- endunless -%}
      {%- endif -%}

      <a href="{{ product.url | within: collection }}" class="product-item-meta__title">{{ product.title }}</a>

      <div class="product-item-meta__price-list-container">
        <div class="price-list price-list--centered">
          {%- if product.price_varies and product.compare_at_price -%}
           
            {%- capture price_min -%}
              {%- if settings.currency_code_enabled -%}
                {{- product.price | money_with_currency -}}
              {%- else -%}
                {{- product.price | money -}}
              {%- endif -%}
            {%- endcapture -%}

            {%- capture compare_at_price_min -%}
              {%- if settings.currency_code_enabled -%}
                {{- product.compare_at_price | money_with_currency -}}
              {%- else -%}
                {{- product.compare_at_price | money -}}
              {%- endif -%}
            {%- endcapture -%}

            {%- if customer and product.price > product.compare_at_price -%}
              <span class="price price--highlight">
                <span class="visually-hidden">{{ 'product.general.sale_price' | t }}</span>
                {{- 'collection.product.from_price_html' | t: price_min: compare_at_price_min -}}
              </span>

              <span class="price price--compare">
                <span class="visually-hidden">{{ 'product.general.regular_price' | t }}</span>

                {%- if settings.currency_code_enabled -%}
                  {{- product.price | money_with_currency -}}
                {%- else -%}
                  {{- product.price | money -}}
                {%- endif -%}
              </span>
            {%- elsif product.price < product.compare_at_price -%}
              <span class="price price--highlight">
                <span class="visually-hidden">{{ 'product.general.sale_price' | t }}</span>
                {{- 'collection.product.from_price_html' | t: price_min: price_min -}}
              </span>

              <span class="price price--compare">
                <span class="visually-hidden">{{ 'product.general.regular_price' | t }}</span>

                {%- if settings.currency_code_enabled -%}
                  {{- product.compare_at_price | money_with_currency -}}
                {%- else -%}
                  {{- product.compare_at_price | money -}}
                {%- endif -%}
              </span>
            {%- else -%}
              <span class="price">
                <span class="visually-hidden">{{ 'product.general.sale_price' | t }}</span>
                {{- 'collection.product.from_price_html' | t: price_min: price_min -}}
              </span>
            {%- endif -%}
          {%- elsif customer and product.price > product.compare_at_price -%}
            <span class="price price--highlight">
              <span class="visually-hidden">{{ 'product.general.sale_price' | t }}</span>

              {%- if settings.currency_code_enabled -%}
                {{- product.compare_at_price | money_with_currency -}}
              {%- else -%}
                {{- product.compare_at_price | money -}}
              {%- endif -%}
            </span>

            <span class="price price--compare">
              <span class="visually-hidden">{{ 'product.general.regular_price' | t }}</span>
              {%- if settings.currency_code_enabled -%}
                {{- product.price | money_with_currency -}}
              {%- else -%}
                {{- product.price | money -}}
              {%- endif -%}
            </span>
          {%- elsif product.price < product.compare_at_price -%}
            <span class="price price--highlight">
              <span class="visually-hidden">{{ 'product.general.sale_price' | t }}</span>

              {%- if settings.currency_code_enabled -%}
                {{- product.price | money_with_currency -}}
              {%- else -%}
                {{- product.price | money -}}
              {%- endif -%}
            </span>

            <span class="price price--compare">
              <span class="visually-hidden">{{ 'product.general.regular_price' | t }}</span>
              {%- if settings.currency_code_enabled -%}
                {{- product.compare_at_price | money_with_currency -}}
              {%- else -%}
                {{- product.compare_at_price | money -}}
              {%- endif -%}
            </span>
          {%- elsif product.price_varies -%}
            {%- capture price_min -%}
              {%- if settings.currency_code_enabled -%}
                {{ product.price_min | money_with_currency }}
              {%- else -%}
                {{ product.price_min | money }}
              {%- endif -%}
            {%- endcapture -%}

            {%- capture price_max -%}
              {%- if settings.currency_code_enabled -%}
                {{- product.price_max | money_with_currency -}}
              {%- else -%}
                {{- product.price_max | money -}}
              {%- endif -%}
            {%- endcapture -%}

            <span class="price">
              <span class="visually-hidden">{{ 'product.general.sale_price' | t }}</span>
              {{- 'collection.product.from_price_html' | t: price_min: price_min, price_max: price_max -}}
            </span>
          {%- else -%}
            <span class="price">
              <span class="visually-hidden">{{ 'product.general.sale_price' | t }}</span>

              {%- if settings.currency_code_enabled -%}
                {{- product.price | money_with_currency -}}
              {%- else -%}
                {{- product.price | money -}}
              {%- endif -%}
            </span>
          {%- endif -%}

          {%- if product.selected_or_first_available_variant.unit_price_measurement -%}
            <div class="price price--block text--xsmall text--subdued">
              <div class="unit-price-measurement">
                <span class="unit-price-measurement__price">{{ product.selected_or_first_available_variant.unit_price | money }}</span>
                <span class="unit-price-measurement__separator">/</span>

                {%- if product.selected_or_first_available_variant.unit_price_measurement.reference_value != 1 -%}
                  <span class="unit-price-measurement__reference-value">{{ product.selected_or_first_available_variant.unit_price_measurement.reference_value }}</span>
                {%- endif -%}

                <span class="unit-price-measurement__reference-unit">{{ product.selected_or_first_available_variant.unit_price_measurement.reference_unit }}</span>
              </div>
            </div>
          {%- endif -%}
        </div>
      </div>

      {%- if settings.show_product_rating and reduced_content != true -%}
        <a class="product-item-meta__reviews-badge text--small" href="{{ product.url }}">
          {%- render 'product-rating', product: product -%}
        </a>
      {%- endif -%}

      {%- if settings.product_color_display != 'hide' and reduced_content != true -%}
        {%- if product.metafields.products.grouped_products != blank -%}
          {%- case settings.product_color_display -%}
            {%- when 'count' -%}
              <p class="product-item-meta__color-count text--small text--subdued">{{- 'collection.product.available_colors_count' | t: count: product_option.values.size -}}</p>
            {%- when 'swatch' -%}
              <div class="product-item-meta__swatch-list color-swatch-list color-swatch-list--mini">
                {%- assign number_of_options = 0 -%}
                {%- for grouped_product in grouped_products -%}
                  {%- if number_of_options > 5 -%}
                    <a href="{{ product.url | within: collection }}" class="more-options">
                      <div class="more-options__item">
                        {%- render 'icon' with 'plus' -%}
                      </div>
                    </a>
                    {%- break -%}
                  {%- endif -%}
                  {%- for color_label in color_label_list -%}
                    {%- if grouped_product.options_by_name[color_label] != blank -%}
                      {%- assign product_option = grouped_product.options_by_name[color_label] -%}
                      {%- assign variant_option = 'option' | append: product_option.position -%}
                      {%- assign color_swatch_config = settings.color_swatch_config | newline_to_br | split: '<br />' -%}
                      {%- capture color_name -%}{{ section.id }}-{{ block.id }}-{{ product.id }}{%- endcapture -%}   
                      {%- for value in product_option.values -%}
                        {%- capture color_id -%}{{ color_name }}-{{ grouped_product.id }}{%- endcapture -%}
                        {%- assign color_value_downcase = value | downcase -%}
                        {%- assign variant_for_value = grouped_product.variants | where: variant_option, value | first -%}
                        <div class="color-swatch {% if color_white_label == color_value_downcase %}color-swatch--white{% endif %} {% if product.id == grouped_product.id %}active{% endif %}">
                          <div class="color-swatch__item" for="{{ color_id }}" title="{{ value }}" style="{% render 'color-swatch-style', color_swatch_config: color_swatch_config, value: value %}" data-product-handle="{{ grouped_product.url }}">
                            <span class="visually-hidden">{{ value }}</span>
                          </div>
                        </div>
                      {%- endfor -%}
                      {%- break -%}
                    {%- endif -%}
                  {%- endfor -%}
                  {%- assign number_of_options = number_of_options | plus: 1 -%}
                {%- endfor -%}
              </div>
              <script type="application/json" data-colors-json>
                {
                  {%- for grouped_product in grouped_products -%}
                    {%- capture image_featured -%}
                      <img class="product-item__primary-image" loading="lazy" data-media-id="{{ grouped_product.featured_media.id | escape }}" sizes="{{ sizes_attribute }}" {% render 'image-attributes', image: grouped_product.featured_media, sizes: '200,300,400,500,600,700,800,900,1000,1100,1200' %}>
                    {%- endcapture -%}
                    {%- capture image_hover -%}
                      {%- assign next_media = grouped_product.media[product.featured_media.position] | default: grouped_product.media[1] -%}
                      <img class="product-item__secondary-image" loading="lazy" sizes="{{ sizes_attribute }}" {% render 'image-attributes', image: next_media, sizes: '200,300,400,500,600,700,800,900,1000,1100,1200' %}>
                    {%- endcapture -%}
                    {%- capture sticker -%}
                      {%- for tag in grouped_product.tags -%}
                        {%- if tag contains '__label' -%}
                          <span class="label label--custom{% if tag contains '__label2' %}2{% endif %}">{{ tag | split: ':' | last }}</span>
                        {%- endif -%}
                      {%- endfor -%}
                      {%- unless grouped_product.available -%}
                        <span class="label label--subdued">{{ 'collection.product.sold_out' | t }}</span>
                      {%- endunless -%}  
                      {%- if settings.show_discount and grouped_product.available -%}
                        {%- if grouped_product.price > grouped_product.compare_at_price and grouped_product.compare_at_price != blank -%}
                          {%- if settings.discount_mode == 'percentage' -%}
                            {%- assign savings = grouped_product.price | minus: grouped_product.compare_at_price | times: 100.0 | divided_by: grouped_product.price | round | append: '%' -%}
                          {%- else -%}
                            {%- capture savings -%}{{ grouped_product.price | minus: grouped_product.compare_at_price | money }}{%- endcapture -%}
                          {%- endif -%}      
                          <span class="label label--highlight">{{ 'collection.product.discount_html' | t: savings: savings }}</span>
                        {%- elsif grouped_product.price < grouped_product.compare_at_price and grouped_product.compare_at_price != blank -%}
                          {%- if settings.discount_mode == 'percentage' -%}
                            {%- assign savings = grouped_product.compare_at_price | minus: grouped_product.price | times: 100.0 | divided_by: grouped_product.compare_at_price | round | append: '%' -%}
                          {%- else -%}
                            {%- capture savings -%}{{ grouped_product.compare_at_price | minus: grouped_product.price | money }}{%- endcapture -%}
                          {%- endif -%}      
                          <span class="label label--highlight">{{ 'collection.product.discount_html' | t: savings: savings }}</span>
                        {%- endif -%}
                      {%- endif -%}
                    {%- endcapture -%}
                    {%- capture price -%}
                      {%- if grouped_product.price_varies and grouped_product.compare_at_price -%}
                        {%- capture price_min -%}
                          {%- if settings.currency_code_enabled -%}
                            {{- grouped_product.price | money_with_currency -}}
                          {%- else -%}
                            {{- grouped_product.price | money -}}
                          {%- endif -%}
                        {%- endcapture -%}  
                        {%- capture compare_at_price_min -%}
                          {%- if settings.currency_code_enabled -%}
                            {{- grouped_product.compare_at_price | money_with_currency -}}
                          {%- else -%}
                            {{- grouped_product.compare_at_price | money -}}
                          {%- endif -%}
                        {%- endcapture -%}    
                        {%- if customer and grouped_product.price > grouped_product.compare_at_price -%}
                          <span class="price price--highlight">
                            <span class="visually-hidden">{{ 'product.general.sale_price' | t }}</span>
                            {{- 'collection.product.from_price_html' | t: price_min: comapre_at_price_min -}}
                          </span>  
                          <span class="price price--compare">
                            <span class="visually-hidden">{{ 'product.general.regular_price' | t }}</span>   
                            {%- if settings.currency_code_enabled -%}
                              {{- grouped_product.price | money_with_currency -}}
                            {%- else -%}
                              {{- grouped_product.price | money -}}
                            {%- endif -%}
                          </span>
                        {%- elsif grouped_product.price < grouped_product.compare_at_price -%}
                          <span class="price price--highlight">
                            <span class="visually-hidden">{{ 'product.general.sale_price' | t }}</span>
                            {{- 'collection.product.from_price_html' | t: price_min: price_min -}}
                          </span>  
                          <span class="price price--compare">
                            <span class="visually-hidden">{{ 'product.general.regular_price' | t }}</span>   
                            {%- if settings.currency_code_enabled -%}
                              {{- grouped_product.compare_at_price | money_with_currency -}}
                            {%- else -%}
                              {{- grouped_product.compare_at_price | money -}}
                            {%- endif -%}
                          </span>
                        {%- else -%}
                          <span class="price">
                            <span class="visually-hidden">{{ 'product.general.sale_price' | t }}</span>
                            {{- 'collection.product.from_price_html' | t: price_min: price_min -}}
                          </span>
                        {%- endif -%}
                      {%- elsif customer and grouped_product.price > grouped_product.compare_at_price -%}
                        <span class="price price--highlight">
                          <span class="visually-hidden">{{ 'product.general.sale_price' | t }}</span>       
                          {%- if settings.currency_code_enabled -%}
                            {{- grouped_product.compare_at_price | money_with_currency -}}
                          {%- else -%}
                            {{- grouped_product.compare_at_price | money -}}
                          {%- endif -%}
                        </span>          
                        <span class="price price--compare">
                          <span class="visually-hidden">{{ 'product.general.regular_price' | t }}</span>
                          {%- if settings.currency_code_enabled -%}
                            {{- grouped_product.price | money_with_currency -}}
                          {%- else -%}
                            {{- grouped_product.price | money -}}
                          {%- endif -%}
                        </span>
                      {%- elsif grouped_product.price < grouped_product.compare_at_price -%}
                        <span class="price price--highlight">
                          <span class="visually-hidden">{{ 'product.general.sale_price' | t }}</span>       
                          {%- if settings.currency_code_enabled -%}
                            {{- grouped_product.price | money_with_currency -}}
                          {%- else -%}
                            {{- grouped_product.price | money -}}
                          {%- endif -%}
                        </span>          
                        <span class="price price--compare">
                          <span class="visually-hidden">{{ 'product.general.regular_price' | t }}</span>
                          {%- if settings.currency_code_enabled -%}
                            {{- grouped_product.compare_at_price | money_with_currency -}}
                          {%- else -%}
                            {{- grouped_product.compare_at_price | money -}}
                          {%- endif -%}
                        </span>
                      {%- elsif grouped_product.price_varies -%}
                        {%- capture price_min -%}
                          {%- if settings.currency_code_enabled -%}
                            {{ grouped_product.price_min | money_with_currency }}
                          {%- else -%}
                            {{ grouped_product.price_min | money }}
                          {%- endif -%}
                        {%- endcapture -%}     
                        {%- capture price_max -%}
                          {%- if settings.currency_code_enabled -%}
                            {{- grouped_product.price_max | money_with_currency -}}
                          {%- else -%}
                            {{- grouped_product.price_max | money -}}
                          {%- endif -%}
                        {%- endcapture -%}
                        <span class="price">
                          <span class="visually-hidden">{{ 'product.general.sale_price' | t }}</span>
                          {{- 'collection.product.from_price_html' | t: price_min: price_min, price_max: price_max -}}
                        </span>
                      {%- else -%}
                        <span class="price">
                          <span class="visually-hidden">{{ 'product.general.sale_price' | t }}</span>   
                          {%- if settings.currency_code_enabled -%}
                            {{- grouped_product.price | money_with_currency -}}
                          {%- else -%}
                            {{- grouped_product.price | money -}}
                          {%- endif -%}
                        </span>
                      {%- endif -%}
                      {%- if grouped_product.selected_or_first_available_variant.unit_price_measurement -%}
                        <div class="price price--block text--xsmall text--subdued">
                          <div class="unit-price-measurement">
                            <span class="unit-price-measurement__price">{{ grouped_product.selected_or_first_available_variant.unit_price | money }}</span>
                            <span class="unit-price-measurement__separator">/</span>    
                            {%- if grouped_product.selected_or_first_available_variant.unit_price_measurement.reference_value != 1 -%}
                              <span class="unit-price-measurement__reference-value">{{ grouped_product.selected_or_first_available_variant.unit_price_measurement.reference_value }}</span>
                            {%- endif -%}
                            <span class="unit-price-measurement__reference-unit">{{ grouped_product.selected_or_first_available_variant.unit_price_measurement.reference_unit }}</span>
                          </div>
                        </div>
                      {%- endif -%}
                    {%- endcapture -%}
                    "{{ grouped_product.url }}": {
                      "title": "{{ grouped_product.title }}",
                      "image_featured": {{ image_featured | json }},
                      "image_hover": {{ image_hover | json }},
                      "price": {{ price | json }},
                      "sticker": {{ sticker | json }}
                    }
                    {% unless forloop.last %},{% endunless %}
                  {%- endfor -%}
                }
              </script>
          {%- endcase -%}
        {%- else -%}   
          {%- for color_label in color_label_list -%}
            {%- if product.options_by_name[color_label] != blank -%}
              {%- assign product_option = product.options_by_name[color_label] -%}
              {%- case settings.product_color_display -%}
                {%- when 'count' -%}
                  <p class="product-item-meta__color-count text--small text--subdued">{{- 'collection.product.available_colors_count' | t: count: product_option.values.size -}}</p>
                {%- when 'swatch' -%}
                  <div class="product-item-meta__swatch-list color-swatch-list color-swatch-list--mini">
                    {%- assign variant_option = 'option' | append: product_option.position -%}
                    {%- assign color_swatch_config = settings.color_swatch_config | newline_to_br | split: '<br />' -%}
                    {%- assign number_of_options = 0 -%}
                    {%- capture color_name -%}{{ section.id }}-{{ block.id }}-{{ product.id }}{%- endcapture -%}

                    {%- for value in product_option.values -%}
                      {%- capture color_id -%}{{ color_name }}-{{ forloop.index }}{%- endcapture -%}
                      {%- assign color_value_downcase = value | downcase -%}
                      {%- assign variant_for_value = product.variants | where: variant_option, value | first -%}
                      {%- if number_of_options > 5 -%}
                        <a href="{{ product.url | within: collection }}" class="more_options">
                          {%- render 'icon' with 'plus' -%}
                        </a>
                        {%- break -%}
                      {%- endif -%}
                      <div class="color-swatch {% if color_white_label == color_value_downcase %}color-swatch--white{% endif %} {% if product_option.selected_value == value %}active{% endif %}">
                        <div class="color-swatch__item" for="{{ color_id }}" title="{{ value }}" style="{% render 'color-swatch-style', color_swatch_config: color_swatch_config, value: value %}" data-product-handle="{{ variant_for_value.url }}">
                          <span class="visually-hidden">{{ value }}</span>
                        </div>
                      </div>
                      {%- assign number_of_options = number_of_options | plus: 1 -%}
                    {%- endfor -%}
                    <script type="application/json" data-colors-json>
                      {
                        {%- for value in product_option.values -%}
                          {%- assign variant_for_value = product.variants | where: variant_option, value | first -%}
                          {%- capture image_featured -%}
                            <img class="product-item__primary-image" loading="lazy" data-media-id="{{ variant_for_value.featured_media.id | escape }}" sizes="{{ sizes_attribute }}" {% render 'image-attributes', image: variant_for_value.featured_media, sizes: '200,300,400,500,600,700,800,900,1000,1100,1200' %}>
                          {%- endcapture -%}
                          {%- capture image_hover -%}
                            {%- for media in product.media -%}
                              {%- if media.alt contains '#' -%}
                                {%- assign alt_parts = media.alt | split: '#' -%}    
                                {%- assign media_group_parts = alt_parts.last | split: '_' -%}
                                {%- assign downcase_group_value = media_group_parts.last | strip | downcase -%}
                                {%- assign downcase_value = value | downcase -%}
                                {%- if downcase_value == downcase_group_value and media.id != variant_for_value.featured_media.id -%}
                                  {%- assign next_media = media -%}
                                  {%- break -%}
                                {%- endif -%}
                              {%- endif -%}
                            {%- endfor -%}                      
                            <img class="product-item__secondary-image" loading="lazy" sizes="{{ sizes_attribute }}" {% render 'image-attributes', image: next_media, sizes: '200,300,400,500,600,700,800,900,1000,1100,1200' %}>
                          {%- endcapture -%}
                          {%- capture sticker -%}
                            {%- for tag in product.tags -%}
                              {%- if tag contains '__label' -%}
                                <span class="label label--custom{% if tag contains '__label2' %}2{% endif %}">{{ tag | split: ':' | last }}</span>
                              {%- endif -%}
                            {%- endfor -%}
                            {%- unless product.available -%}
                              <span class="label label--subdued">{{ 'collection.product.sold_out' | t }}</span>
                            {%- endunless -%}
                            {%- if settings.show_discount and product.available -%} 
                              {%- if customer and product.price > product.compare_at_price and product.price != blank -%}
                                {%- if settings.discount_mode == 'percentage' -%}
                                  {%- assign savings = product.price | minus: product.compare_at_price | times: 100.0 | divided_by: product.price | round | append: '%' -%}
                                {%- else -%}
                                  {%- capture savings -%}{{ product.price | minus: product.compare_at_price | money }}{%- endcapture -%}
                                {%- endif -%}      
                                <span class="label label--highlight">{{ 'collection.product.discount_html' | t: savings: savings }}</span>
                              {%- elsif product.price < product.compare_at_price and product.compare_at_price != blank -%}
                                {%- if settings.discount_mode == 'percentage' -%}
                                  {%- assign savings = product.compare_at_price | minus: product.price | times: 100.0 | divided_by: product.compare_at_price | round | append: '%' -%}
                                {%- else -%}
                                  {%- capture savings -%}{{ product.compare_at_price | minus: product.price | money }}{%- endcapture -%}
                                {%- endif -%}      
                                <span class="label label--highlight">{{ 'collection.product.discount_html' | t: savings: savings }}</span>
                              {%- endif -%}
                            {%- endif -%}
                          {%- endcapture -%}
                          {%- capture price -%}
                            {%- if product.price_varies and product.compare_at_price -%}
                              {%- capture price_min -%}
                                {%- if settings.currency_code_enabled -%}
                                  {{- product.price | money_with_currency -}}
                                {%- else -%}
                                  {{- product.price | money -}}
                                {%- endif -%}
                              {%- endcapture -%}  
                              {%- capture compare_at_price_min -%}
                                {%- if settings.currency_code_enabled -%}
                                  {{- product.compare_at_price | money_with_currency -}}
                                {%- else -%}
                                  {{- product.compare_at_price | money -}}
                                {%- endif -%}
                              {%- endcapture -%}    
                              {%- if customer and product.price > product.compare_at_price -%}
                                <span class="price price--highlight">
                                  <span class="visually-hidden">{{ 'product.general.sale_price' | t }}</span>
                                  {{- 'collection.product.from_price_html' | t: price_min: compare_at_price_min -}}
                                </span>  
                                <span class="price price--compare">
                                  <span class="visually-hidden">{{ 'product.general.regular_price' | t }}</span>   
                                  {%- if settings.currency_code_enabled -%}
                                    {{- product.price | money_with_currency -}}
                                  {%- else -%}
                                    {{- product.price | money -}}
                                  {%- endif -%}
                                </span>
                              {%- elsif product.price < product.compare_at_price -%}
                                <span class="price price--highlight">
                                  <span class="visually-hidden">{{ 'product.general.sale_price' | t }}</span>
                                  {{- 'collection.product.from_price_html' | t: price_min: price_min -}}
                                </span>  
                                <span class="price price--compare">
                                  <span class="visually-hidden">{{ 'product.general.regular_price' | t }}</span>   
                                  {%- if settings.currency_code_enabled -%}
                                    {{- product.compare_at_price | money_with_currency -}}
                                  {%- else -%}
                                    {{- product.compare_at_price | money -}}
                                  {%- endif -%}
                                </span>
                              {%- else -%}
                                <span class="price">
                                  <span class="visually-hidden">{{ 'product.general.sale_price' | t }}</span>
                                  {{- 'collection.product.from_price_html' | t: price_min: price_min -}}
                                </span>
                              {%- endif -%}
                            {%- elsif customer and product.price > product.compare_at_price -%}
                              <span class="price price--highlight">
                                <span class="visually-hidden">{{ 'product.general.sale_price' | t }}</span>       
                                {%- if settings.currency_code_enabled -%}
                                  {{- product.compare_at_price | money_with_currency -}}
                                {%- else -%}
                                  {{- product.compare_at_price | money -}}
                                {%- endif -%}
                              </span>          
                              <span class="price price--compare">
                                <span class="visually-hidden">{{ 'product.general.regular_price' | t }}</span>
                                {%- if settings.currency_code_enabled -%}
                                  {{- product.price | money_with_currency -}}
                                {%- else -%}
                                  {{- product.price | money -}}
                                {%- endif -%}
                              </span>
                            {%- elsif product.price < product.compare_at_price -%}
                              <span class="price price--highlight">
                                <span class="visually-hidden">{{ 'product.general.sale_price' | t }}</span>       
                                {%- if settings.currency_code_enabled -%}
                                  {{- product.price | money_with_currency -}}
                                {%- else -%}
                                  {{- product.price | money -}}
                                {%- endif -%}
                              </span>          
                              <span class="price price--compare">
                                <span class="visually-hidden">{{ 'product.general.regular_price' | t }}</span>
                                {%- if settings.currency_code_enabled -%}
                                  {{- product.compare_at_price | money_with_currency -}}
                                {%- else -%}
                                  {{- product.compare_at_price | money -}}
                                {%- endif -%}
                              </span>
                            {%- elsif product.price_varies -%}
                              {%- capture price_min -%}
                                {%- if settings.currency_code_enabled -%}
                                  {{ product.price_min | money_with_currency }}
                                {%- else -%}
                                  {{ product.price_min | money }}
                                {%- endif -%}
                              {%- endcapture -%}     
                              {%- capture price_max -%}
                                {%- if settings.currency_code_enabled -%}
                                  {{- product.price_max | money_with_currency -}}
                                {%- else -%}
                                  {{- product.price_max | money -}}
                                {%- endif -%}
                              {%- endcapture -%}
                              <span class="price">
                                <span class="visually-hidden">{{ 'product.general.sale_price' | t }}</span>
                                {{- 'collection.product.from_price_html' | t: price_min: price_min, price_max: price_max -}}
                              </span>
                            {%- else -%}
                              <span class="price">
                                <span class="visually-hidden">{{ 'product.general.sale_price' | t }}</span>   
                                {%- if settings.currency_code_enabled -%}
                                  {{- product.price | money_with_currency -}}
                                {%- else -%}
                                  {{- product.price | money -}}
                                {%- endif -%}
                              </span>
                            {%- endif -%}
                            {%- if product.selected_or_first_available_variant.unit_price_measurement -%}
                              <div class="price price--block text--xsmall text--subdued">
                                <div class="unit-price-measurement">
                                  <span class="unit-price-measurement__price">{{ product.selected_or_first_available_variant.unit_price | money }}</span>
                                  <span class="unit-price-measurement__separator">/</span>    
                                  {%- if product.selected_or_first_available_variant.unit_price_measurement.reference_value != 1 -%}
                                    <span class="unit-price-measurement__reference-value">{{ product.selected_or_first_available_variant.unit_price_measurement.reference_value }}</span>
                                  {%- endif -%}
                                  <span class="unit-price-measurement__reference-unit">{{ product.selected_or_first_available_variant.unit_price_measurement.reference_unit }}</span>
                                </div>
                              </div>
                            {%- endif -%}
                          {%- endcapture -%}
                          "{{ variant_for_value.url }}": {
                            "title": "{{ product.title }}",
                            "image_featured": {{ image_featured | json }},
                            "image_hover": {{ image_hover | json }},
                            "price": {{ price | json }},
                            "sticker": {{ sticker | json }}
                          }
                          {% unless forloop.last %},{% endunless %}
                        {%- endfor -%}
                      }
                    </script>
                  </div>
              {%- endcase -%}
              {%- break -%}
            {%- endif -%}
          {%- endfor -%}
        {%- endif -%}
      {%- endif -%}
    </div>

    {%- if product.available and show_cta -%}
      <div class="product-item__cta-wrapper">
        {%- if product.variants.size == 1 -%}
          {%- capture form_id -%}product_form_{{ section.id }}_{{ block.id }}_{{ product.id }}_{% increment product_form_index %}{%- endcapture -%}
          {%- form 'product', product, is: 'product-form', id: form_id -%}
            <input type="hidden" name="quantity" value="1">
            <input type="hidden" name="id" value="{{ product.first_available_variant.id }}">
            <button type="submit" {% if show_cta %}is="loader-button"{% endif %} class="{% if reduced_content %}button button--xsmall button--outline{% else %}product-item__cta button button--primary{% endif %}">{{ 'collection.product.add_to_cart_short' | t }}</button>
          {%- endform -%}
        {%- endif -%}
      </div>
    {%- endif -%}
  </div>
</product-item>